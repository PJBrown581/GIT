<?xml version="1.0" encoding="utf-8"?>
<AxClass xmlns:i="http://www.w3.org/2001/XMLSchema-instance">
	<Name>DocSalesInvoiceReportDSP</Name>
	<SourceCode>
		<Declaration><![CDATA[
class DocSalesInvoiceReportDSP extends DocDataSourceProviderSrsProforma
{
    SalesInvoiceTmp                         salesInvoiceLineWithHeaderFields;
    SalesInvoiceHeaderFooterTmp             salesInvoiceHeaderFlagFields;
    LogisticsAddressCountryRegionISOCode    isoCountryCode;
    SalesInvoiceContract                    salesInvoiceContract;
    boolean                                 showPrepaidTotals, showCustPaymSched;
    SalesTable                              salesTable;
    DocTableFieldsMetadata                  extensionFieldsMetadata_SalesInvoiceTmp = DocTableFieldsMetadata::construct(tableStr(SalesInvoiceTmp));
    
    /* Variables for custom placeholders */
    str         placeholder_invoiceId;
    str         placeholder_salesId;
    str         placeholder_invoiceAccount;
    str         placeholder_invoicingName;
    str         placeholder_contactName;
    str         placeholder_custRef;
    str         placeholder_custReq;
    date        placeholder_invoiceDate;
    date        placeholder_dueDate;
    str         placeholder_paymentCondition;
    str         placeholder_orderAccountPrimaryEmail;
    str         placeholder_orderAccountInvoicePurposeEmail;


    #ISOCountryRegionCodes

    #define.SalesInvoiceHeader('SalesInvoiceHeader')
    #define.SalesInvoiceHeaderExt('SalesInvoiceHeaderExt')

    #define.SalesInvoiceLines('SalesInvoiceLines')
    #define.TaxLines('SalesInvoiceLines_Tax')
    #define.TaxWithholdLines('SalesInvoiceLines_TaxWithhold')
    #define.PrepayedLines('SalesInvoiceLines_Prepayed')
    #define.PaymSchedLines('SalesInvoiceLines_PaymSched')
    #define.MarkupLines('SalesInvoiceLines_Markup')
    #define.PackingMaterialLines('SalesInvoiceLines_PackingMaterial')
    #define.BackorderLines('SalesInvoiceLines_Backorder')
    #define.PaymentStub('SalesInvoicePaymentStub')
    #define.GiroReportData('GiroData')

    #define.SalesInvoiceLinesLocalization('SalesInvoiceLocalizationLines')

    #define.DefaultDimensionField('FinancialDimensions')


}
]]></Declaration>
		<Methods>
			<Method>
				<Name>addCustomLabels</Name>
				<Source><![CDATA[
    // This overridden method adds additional custom labels to the DDSP to use them in template designer.
    // Learn more: https://ax.docentric.com/d365-how-to-manuals/d365-miscellaneous/d365-how-to-add-missing-labels-to-multilingual-reports/
    protected void addCustomLabels(Map _labelMap)
    {
        super(_labelMap);

        // Labels in order of appearance on document from top to bottom, left to right.

        // Address information.
        _labelMap.insert(literalStr("@SYS325235"), 'Contact');
        _labelMap.insert(literalStr("@AccountsReceivable:YourTaxExemptNumber"), 'Your tax exempt number');
        _labelMap.insert(literalStr("@SYS77429"), 'Enterprise number');
        
        // Company information.
        _labelMap.insert(literalStr("@SYS5231"), 'Giro');
        _labelMap.insert(literalStr("@SYS26946"), 'Tax exempt number');     // VAT ID

        // Document header.
        _labelMap.insert(literalStr("@SYS4160085"), 'Special regime for cash accounting method');
        _labelMap.insert(literalStr("@SYS97575"), 'Customer invoice reference number');
        _labelMap.insert(literalStr("@SYS13864"), 'Number');
        _labelMap.insert(literalStr("@SYS57610"), 'Invoice date');
        _labelMap.insert(literalStr("@SYS7426"), 'Page'); // Pagination.
        _labelMap.insert(literalStr("@SYS26401"), 'of'); // Pagination.
        _labelMap.insert(literalStr("@SYS121179"), 'Date and time');
        _labelMap.insert(literalStr("@SYS9452"), 'Requisition');
        _labelMap.insert(literalStr("@SYS106366"), 'Your reference');
        _labelMap.insert(literalStr("@SYS4081689"), 'Our Reference');
        _labelMap.insert(literalStr("@SYS99716"), 'Corrected invoice');
        _labelMap.insert(literalStr("@SYS99726"), 'Original total invoice amount');
        _labelMap.insert(literalStr("@SYS99725"), 'Original total VAT amount');

        // Document lines.
        _labelMap.insert(literalStr("@SYS6303"), 'Description');
        _labelMap.insert(literalStr("@SYS11770"), 'Unit price');
        _labelMap.insert(literalStr("@SYS21906"), 'Print code');
        _labelMap.insert(literalStr("@SYS11549"), 'Packing slip'); // Only present on Italian localization.
        _labelMap.insert(literalStr("@SYS4081423"), 'CW quantity: %1');
        _labelMap.insert(literalStr("@SYS4081424"), 'CW unit: %1');
        
        // Backorder lines.
        _labelMap.insert(literalStr("@SYS6913"), 'Backorders');
        _labelMap.insert(literalStr("@SYS7108"), 'Remaining quantity');

        // Sales tax lines.
        _labelMap.insert(literalStr("@SYS99166"), 'Percent cash discount');
        _labelMap.insert(literalStr("@SYS7576"), 'Description');

        // Payment schedule information.
        _labelMap.insert(literalStr("@SYS26885"), 'Following payment schedule has been agreed');
        _labelMap.insert(literalStr("@SYS9458"), 'Invoice amount');

        // Depreciation of prepayments information.
        _labelMap.insert(literalStr("@SYS62136"), 'Depreciation of prepayments');
        _labelMap.insert(literalStr("@SYS6928"), 'Amount');

        // Packing material information.
        _labelMap.insert(literalStr("@SYS73000"), 'Print packing material weight');

        // Prepaid totals information.
        _labelMap.insert(literalStr("@SYS9242"), 'Total');
        _labelMap.insert(literalStr("@SYS50745"), 'Prepaid');
        _labelMap.insert(literalStr("@SYS53728"), 'Remainder');

        // Total tax balances information.
        _labelMap.insert(literalStr("@SYS10946"), 'Cash discount amount');
        _labelMap.insert(literalStr("@SYS8172"), 'Round-off');

        // SEPA information.
        _labelMap.insert(literalStr("@SYS4002667"), 'SEPA Notification Header');
        _labelMap.insert(literalStr("@SYS4002672"), 'Payment for this invoice will be made from the following accounts at the earliest of');
        _labelMap.insert(literalStr("@SYS4002628"), 'Mandate ID');
        _labelMap.insert(literalStr("@SYS4002593"), 'Creditor');
        _labelMap.insert(literalStr("@SYS4002595"), 'Creditor ID');
        _labelMap.insert(literalStr("@SYS4002614"), 'Debtor name');
        _labelMap.insert(literalStr("@SYS4002613"), 'Debtor IBAN');
        _labelMap.insert(literalStr("@SYS4002615"), 'Debtor SWIFT Code');

        // Footer additional information.
        _labelMap.insert(literalStr("@SYS95976"), '** -Excluded by article 15');
        _labelMap.insert(literalStr("@SYP4882000"), 'This invoice originates from a bookkeeping system...'); // Regulation 505/2013.
        _labelMap.insert(literalStr("@SYS118818"), 'Reverse charge');

        // Italian localization.
        _labelMap.insert(literalStr("@SYS95973"), '*Goods discount');
        _labelMap.insert(literalStr("@ExtendedItallianLocalization:Of"), 'of');
        _labelMap.insert(literalStr("@ExtendedItallianLocalization:IntentLetter"), 'Intent letter');
        _labelMap.insert(literalStr("@SYS130659"), 'Date');
        _labelMap.insert(literalStr("@SYS35164"), 'Validity');

        // Misc.
        _labelMap.insert(literalStr("@SYS4376"), 'Cash discount');
    }

]]></Source>
			</Method>
			<Method>
				<Name>addDataFieldsForHeader</Name>
				<Source><![CDATA[
    protected void addDataFieldsForHeader(DocXmlRecord _addingRecord, SalesInvoiceHeaderFooterTmp _header)
    {
        /* This method contains all fields from the SalesInvoiceHeaderFooterTmp table */
        void addFieldsFromSalesInvoiceHeaderFooterTmp()
        {
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, BankSpecificSymbol));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, BuyerAddress));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, BuyerEnterpriseCode));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, BuyerName));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyDebitDirectId));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, ConstantSymbol));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, ContactPersonName));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CorrectedInvoiceId));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CorrectiveReasonHeader));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CustomerBankAccount));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CustomerBankName));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CustomerRef));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, DocumentDate));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, DuplicateDate));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, DuplicateNum));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, EnterpriseNumber));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, Enterpriseregister_NO));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, Iban));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceAccount));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceDate));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceReferenceNumber));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceTxt));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceTxtSequel));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoicingAddress));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoicingName));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, Listcode));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, NotesLine_FR));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, OriginalInvoiceAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, OriginalInvoiceReference));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, OriginalVatAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, PayerEnterpriseCode));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, PaymentCondition));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, PaymentReference));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, PaymId));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, PurchaseOrder));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, Reference));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SalesAdministrator));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SalesAdministratorEmail));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SalesAdministratorPhone));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SalesDate));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SalesId));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SpecialFormattedDocumentDate));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SpecialFormattedInvoiceDate));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SpecialFormattedPrintDate));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, SwiftNumber));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, TaxLicenseNum));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, VatNum));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, VatDueDate_W));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, PayerRegNum_W));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, BuyerRegNum_W));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, MCRDlvMode));
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, MCRDlvTerm));
            _addingRecord.addCalculatedField('MCRDlvModeText', DlvMode::find(_header.MCRDlvMode).Txt);
            _addingRecord.addCalculatedField('MCRDlvTermText', DlvTerm::find(_header.MCRDlvTerm).Txt);


            /* CONTROL FLAGS AND SPECIAL FORMATTING DATA */
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, JournalRecId));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CustInvoiceRefNum_FI));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, ShowCompanyVATNum));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, ShowCurrencyBankAccount));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, ShowPayer));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IsPaymIdVisible));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, PrintFreeTextInvoiceVATNum));

            // Group and add flags to the SalesInvoiceHeaderExt record in the generateXmlDataSource() method,
            // with other flags that come from the SalesInvoiceTmp table.
            buf2Buf(_header, salesInvoiceHeaderFlagFields);


            /* COUNTRY REGION RELATED DATA */
            switch (isoCountryCode)
            {
                case #isoTH:
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyBranch_TH));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceBranch_TH));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceTaxNatureOfAddress_TH));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceTaxRegNumber_TH));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceTxtNote_TH));     // NOTE: Available from the July 2017 version.
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CustomerPhone_TH));      // NOTE: Available from the July 2017 version.
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CustomerTeleFax_TH));    // NOTE: Available from the July 2017 version.
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceBranchName_TH));  // NOTE: Available from the July 2017 version.
                    break;

                case #isoMY:
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, GSTReasonCode_MY));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, GSTReliefClause_MY));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, InvoiceType_MY));
                    break;

                case #isoIT:
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IntentLetterDate_IT));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IntentLetterFromDate_IT));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IntentLetterId_IT));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IntentLetterInternalId_IT));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IntentLetterPostingDate_IT));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IntentLetterProtocol_IT));
                    _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, IntentLetterToDate_IT));
            }

            /* COMPANY RELATED DATA */
            _addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyAddress)).setFieldName('CompanyAddressTranslatedCountry');      //NOTE: Translated with DirUtility::replaceAddressTokenLanguage().
            // NOTE: The company data are excluded since we have them in the GeneralData data section.
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyAddress));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyBankAccount));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyBankName));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyCommercialRegister));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyCommercialRegisterInsetNumber));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyCommercialRegisterSection));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyCoRegNum));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyCurrencyBankAccount));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyCurrencyBankName));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyCurrencyCode));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyEmail));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyEnterpriseCode));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyEnterpriseNumber));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyGiro));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyLogo));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyName));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyPhone));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyRegNum));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyTeleFax));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyURL));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyVATNum));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyRegComFR));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyLegalFormFR));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyInitialCapital_FR));
            //_addingRecord.addField(fieldStr(SalesInvoiceHeaderFooterTmp, CompanyIdNAF));
        }


        // Populate BuyerAddress and BuyerName if they were not populated in the SalesInvoiceDP class:
        // (they get populated only for European eastern countries)
        if (!_header.BuyerName)
        {
            _header.BuyerAddress = this.custInvoiceJour().deliveryAddress();
            _header.BuyerName = this.custInvoiceJour().DeliveryName;
        }

        // Setting the flag needed for Docentric NextGen.
        _addingRecord.setSingleRecord(true);

        // (1) Change the name of the adding record from 'SalesInvoiceHeaderFooterTmp'
        // to a more readable name, e.g. 'SalesInvoiceHeader'.
        _addingRecord.setRecordName(#SalesInvoiceHeader);
        // Change the label of the record.
        _addingRecord.setRecordLabel('Invoice header');  // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

        // (2) Add the needed fields from the SalesInvoiceHeaderFooterTmp table.
        addFieldsFromSalesInvoiceHeaderFooterTmp();

        // (3) Add Sales order email and Customer primary email.
        _addingRecord.addCalculatedField('OrderEmail', salesTable.Email);
        CustTable custTable_InvoiceAccount = salesTable.custTable_InvoiceAccount();
        _addingRecord.addCalculatedField('CustomerEmail', custTable_InvoiceAccount.email());
        CustTable custTable_OrderAccount = salesTable.custTable_CustAccount();
        _addingRecord.addCalculatedField('OrderAccountEmail', custTable_OrderAccount.email());
        // See the references to the Account field of the CustVendAccountMap map for the explanation.

        // (4) Add the Blind shipment flag
        _addingRecord.addCalculatedFieldFromEdt('ShipCarrierBlindShipment', extendedTypeStr(ShipCarrierBlindShipment), this.custInvoiceJour().ShipCarrierBlindShipment);

        // (5) Add Custom Fields defined on SalesTable and CustTable, if any.
        // Custom Fields: https://docs.microsoft.com/en-us/dynamics365/unified-operations/fin-and-ops/get-started/user-defined-fields
        DocCustomFieldsHelper::tryAddAllCustomFieldsToDataRecord(salesTable, _addingRecord);
        DocCustomFieldsHelper::tryAddAllCustomFieldsToDataRecord(custTable_InvoiceAccount, _addingRecord);
        // NOTE: You don't have to add all Custom Fields but only specific ones:
        //DocCustomFieldsHelper::addCustomFieldsToDataRecord(['CustomFieldName1', 'CustomFieldName2'], salesTable, _addingRecord);
        //DocCustomFieldsHelper::addCustomFieldToDataRecord('CustomFieldName', salesTable, _addingRecord);

        // (6) Add Financial dimensions.
        _addingRecord.addCalculatedFieldFromEdt(#DefaultDimensionField, extendedTypeStr(DimensionDefault), this.custInvoiceJour().DefaultDimension);        
        
        // (7) Add Extension fields defined on SalesInvoiceHeaderFooterTmp, if any.
        // NOTE: Fields will be added to the child record named ExtensionFields. Change the last parameter to false to add
        // Extension fields on flat. If the result doesn't suit you, add your Extension fields directly using the addField() method.
        DocExtensionFieldsHelper::tryAddAllExtensionFieldsToDataRecord(_header, _addingRecord, true);


        // TODO: Add here additional fields (or records) to the single header record by using the related
        // data to the _header table buffer (SalesInvoiceHeaderFooterTmp) or reportContract.
        // For example, get the related CustInvoiceJour record and add additional data you need:
        //CustInvoiceJour custInvoiceJour = this.custInvoiceJour();
        //DocXmlRecord jourDataRecord = _addingRecord.addChildRecord(custInvoiceJour);
        //jourDataRecord.addField(fieldStr(CustInvoiceJour, DeliveryName));
        //jourDataRecord.addDisplayMethod(tableMethodStr(CustInvoiceJour, isSummaryUpdated));
        // Or, add the customer payment type:
        //_addingRecord.addCalculatedField('CustomerPaymentType', CustTable::find(_header.InvoiceAccount).paymentType());
    }

]]></Source>
			</Method>
			<Method>
				<Name>addDataFieldsForLine</Name>
				<Source><![CDATA[
    protected void addDataFieldsForLine(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine)
    {
        // (1) Store the first SalesInvoiceTmp record into a global variable. It will be used later,
        // in the generateXmlDataSource() method, to add fields that should be 'moved' to the header.
        if (salesInvoiceLineWithHeaderFields.RecId == 0)
        {
            buf2Buf(_currentLine, salesInvoiceLineWithHeaderFields);
            salesInvoiceLineWithHeaderFields.RecId = _currentLine.RecId;
        }

        // (2) Add the needed fields from the SalesInvoiceTmp table.
        // NOTE: EXCLUDE all fields you don't need on the report in the methods that
        // follow for the sake of maintenance. From these methods EXCLUDE all unnecessary fields
        // likewise INCLUDE additional fields you may need.

        // (3) If the ShowPrepaidTotals flag is true for at least one line,
        // the corresponding table should be displayed on the report printout.
        if (!showPrepaidTotals)
        {
            showPrepaidTotals = _currentLine.ShowPrepaidTotals;
        }

        // Add the data fields that originate from the related CustInvoiceTrans record.
        if (this.sil_addMainLines(_addingRecord, _currentLine, false))
        {
            return;
        }

        /*****  Fields that represent different types of lines  *****/
        // 1) TaxLines
        if (this.sil_addTaxTransLines(_addingRecord, _currentLine, false))
        {
            return;
        }

        // 2) TaxWithholdLines
        if (this.sil_addTaxWithholdLines(_addingRecord, _currentLine, false))
        {
            return;
        }

        // 3) PrepayedLines
        if (this.sil_addCustTransLines(_addingRecord, _currentLine, false))
        {
            return;
        }

        // 4) PaymSchedLines
        if (this.sil_addPaymSchedLines(_addingRecord, _currentLine, false))
        {
            return;
        }

        // 5) MarkupLines
        if (this.sil_addMarkupLines(_addingRecord, _currentLine, false))
        {
            return;
        }

        // 6) PackingMaterialLines
        if (this.sil_addPackMaterialLines(_addingRecord, _currentLine, false))
        {
            return;
        }

        // 7) BackorderLines
        if (this.sil_addBackorderLines(_addingRecord, _currentLine, false))
        {
            return;
        }


        if (!this.isRuntime())
        {
            _addingRecord.setRecordName('SalesInvoiceLine_UnsupportedType');
            _addingRecord.addAllFields();
            DocGlobalHelper::handleWarning('Unsupported type of the SalesInvoiceTmp line');
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>addDataFieldsForLocalizationLine</Name>
				<Source><![CDATA[
    protected void addDataFieldsForLocalizationLine(DocXmlRecord _addingRecord, SalesInvoiceLocalizationTmp _currentLocalizationLine)
    {
        // Change the name of the adding record from 'SalesInvoiceLocalizationTmp'
        // to a more readable name, e.g. 'SalesInvoiceLinesLocalization'.
        _addingRecord.setRecordName(#SalesInvoiceLinesLocalization);
        // Change the label of the record.
        _addingRecord.setRecordLabel('Invoice localization line');  // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.
        _addingRecord.addAllFields();

        // NOTE: SalesInvoiceLocalizationTmp is used only for the following countries:
        // #isoEE, #isoLT, #isoHU, #isoLV, #isoCZ, #isoPL.
        // This method never gets executed for a contry outside this list.
        // In that case this method should be removed.
    }

]]></Source>
			</Method>
			<Method>
				<Name>addDataFieldsForRdpTableRecord</Name>
				<Source><![CDATA[
    protected void addDataFieldsForRdpTableRecord(DocXmlRecord _addingRecord, Common _rdpTableRecord, TableName _rdpTableName)
    {
        if (_rdpTableName == tableStr(SalesInvoiceHeaderFooterTmp))
        {
            this.addDataFieldsForHeader(_addingRecord, _rdpTableRecord);
        }
        else if (_rdpTableName == tableStr(SalesInvoiceTmp))
        {
            this.addDataFieldsForLine(_addingRecord, _rdpTableRecord);
        }
        else if (_rdpTableName == tableStr(SalesInvoiceLocalizationTmp))
        {
            this.addDataFieldsForLocalizationLine(_addingRecord, _rdpTableRecord);
        }
        else if (_rdpTableName == tableStr(SalesInvoicePaymentStubTmp))
        {
            _addingRecord.setRecordName(#PaymentStub).setRecordLabel('Payment stub').setSingleRecord(true);
            super(_addingRecord, _rdpTableRecord, _rdpTableName);

            // NOTE: Uncomment the following code to add the GiroReportTmp data.
            // This is the case when you need Invoice and Giro data to be part of the same DDSP and
            // available for use on all report templates.
            /*
            DocXmlRecord giroReportTmpRecord = _addingRecord.addChildRecord(this.populateGiroReportTmpTable(_rdpTableRecord))
                                                            .setRecordName(#GiroReportData).setRecordLabel('Giro data').setSingleRecord(true);
            giroReportTmpRecord.addAllFields();
            */
        }
        else
        {
            super(_addingRecord, _rdpTableRecord, _rdpTableName);
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>description</Name>
				<Source><![CDATA[
    public ClassDescription description()
    {
        return 'Customer invoice DSP';
    }

]]></Source>
			</Method>
			<Method>
				<Name>generateXmlDataSource</Name>
				<Source><![CDATA[
    protected void generateXmlDataSource(DocXmlRecordBuilder _recordBuilder)
    {
        SalesInvoiceTmp             salesInvoiceTmpEmptyFields;
        SalesInvoicePaymentStubTmp  salesInvoicePaymentStubTmpEmptyFields;
        GiroReportTmp               giroReportTmpEmptyFields;
        DocXmlRecord                salesInvoiceTmpEmptyFieldsDataRecord, headerExtDataRecord;


        // Build the internal record tree from the built-in report RDP tables.
        super(_recordBuilder);


        // (1) Add all fields from SalesInvoiceTmp which should be moved to the header
        // (but only if this is not a localization case where regular lines are excluded from DS)
        if (salesInvoiceLineWithHeaderFields.RecId != 0)
        {
            _recordBuilder.goToTopRecord();
            headerExtDataRecord = _recordBuilder.addRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceHeaderExt'.
            headerExtDataRecord.setRecordName(#SalesInvoiceHeaderExt);
            // Change the label of the record.
            headerExtDataRecord.setRecordLabel('Invoice header extended'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.
            // Add all 'header' fields from the stored line record.
            this.sih_addDataFieldsForHeaderExt(headerExtDataRecord);
        }


        // (2) If this is design time, add all empty type of lines that haven't been already added.
        _recordBuilder.goToTopRecord();
        if (!this.isRuntime() && salesInvoiceLineWithHeaderFields.RecId != 0)
        {
            salesInvoiceTmpEmptyFields.clear();

            // Main lines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#SalesInvoiceLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addMainLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // TaxLines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#TaxLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addTaxTransLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // TaxWithholdLines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#TaxWithholdLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addTaxWithholdLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // PrepayedLines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#PrepayedLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addCustTransLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // PaymSchedLines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#PaymSchedLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addPaymSchedLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // MarkupLines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#MarkupLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addMarkupLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // PackingMaterialLines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#PackingMaterialLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addPackMaterialLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // BackorderLines.
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#BackorderLines) == null)
            {
                salesInvoiceTmpEmptyFieldsDataRecord = _recordBuilder.addRecord(salesInvoiceTmpEmptyFields);
                this.sil_addBackorderLines(salesInvoiceTmpEmptyFieldsDataRecord, salesInvoiceTmpEmptyFields, true);
                _recordBuilder.goToTopRecord();
            }

            // SalesInvoicePaymentStubTmp
            if (_recordBuilder.currentRecord().getFirstChildRecordByName(#PaymentStub) == null)
            {
                _recordBuilder.addRecord(salesInvoicePaymentStubTmpEmptyFields).setRecordName(#PaymentStub).setRecordLabel('Payment stub').setSingleRecord(true).addAllFields();
                _recordBuilder.addRecord(giroReportTmpEmptyFields).setRecordName(#GiroReportData).setRecordLabel('Giro data').setSingleRecord(true).addAllFields();

                _recordBuilder.goToTopRecord();
            }
        }

        // Check the resulting XML.
        //info(_recordBuilder.exportToXmlStr());
        //_recordBuilder.exportToXmlFile("ReportMainData.xml");
    }

]]></Source>
			</Method>
			<Method>
				<Name>preRunGenerateDS</Name>
				<Source><![CDATA[
    protected void preRunGenerateDS()
    {
        super();

        // Initialize here the class global variables.
        salesInvoiceLineWithHeaderFields.clear();
        salesInvoiceHeaderFlagFields.clear();
        showPrepaidTotals = false;
        showCustPaymSched = false;

        salesInvoiceContract = this.getSrsRdpContract();
        isoCountryCode = SysCountryRegionCode::countryInfo();
    }

]]></Source>
			</Method>
			<Method>
				<Name>proformaReportStoragePrefix</Name>
				<Source><![CDATA[
    protected str proformaReportStoragePrefix()
    {
        return DocConstantDSP::Prefix_SalesInvoice;
    }

]]></Source>
			</Method>
			<Method>
				<Name>custInvoiceJour</Name>
				<Source><![CDATA[
    protected CustInvoiceJour custInvoiceJour()
    {
        if (!journal)
        {
            if (this.isProforma())
            {
                journal = this.getProformaJournal();
            }
            else
            {
                journal = CustInvoiceJour::findRecId(journalRecId);
            }
        }

        return journal;
    }

]]></Source>
			</Method>
			<Method>
				<Name>custInvoiceTrans</Name>
				<Source><![CDATA[
    protected CustInvoiceTrans custInvoiceTrans(RecId _custInvoiceTransRecId)
    {
        CustInvoiceTrans custInvoiceTrans;

        if (this.isProforma())
        {
            custInvoiceTrans = this.getProformaTransLine(_custInvoiceTransRecId);
        }
        else
        {
            custInvoiceTrans = CustInvoiceTrans::findRecId(_custInvoiceTransRecId);
        }

        return custInvoiceTrans;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sih_addDataFieldsForHeaderExt</Name>
				<Source><![CDATA[
    protected void sih_addDataFieldsForHeaderExt(DocXmlRecord _headerExtDataRecord)
    {
        DocXmlRecord childRecord;

        /*****  Fields that are moved to the extended invoice header  *****/
        /* IDs */
        _headerExtDataRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceId));
        _headerExtDataRecord.addField(fieldStr(SalesInvoiceTmp, TaxInvoiceSalesId));

        /* Flags */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('Flags');
        childRecord.setRecordLabel('Flags');

        // Fix the ShowPrepaidTotals flag since it is set only in the CustTrans ('prepaid') lines.
        // For that use the stored value in the showPrepaidTotals variable.
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowPrepaidTotals))
               .setFieldValue(showPrepaidTotals);
        
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowPrepaidTotalsEuro));

        // Fix the ShowCustPaymSched flag since it is set only in the PaymSchedLines lines.
        // For that use the stored value in the showCustPaymSched variable.
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowCustPaymSched))
               .setFieldValue(showCustPaymSched);

        childRecord.addField(fieldStr(SalesInvoiceTmp, IsTaxAmountMSTVisible));
        childRecord.addField(fieldStr(SalesInvoiceTmp, IsCreditInvoicingReportEnabled));
        childRecord.addField(fieldStr(SalesInvoiceTmp, IsInvoiceRefVisible));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowCashDiscOnInvoiceControls));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowSepaNotification));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowPayment));

        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowTotals));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowTotalsEuro));

        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowTotalsTaxBalances));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowGiro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowLocalCurAmt));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ShowTotalsTaxBalancesEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ConfigIdFlag));
        childRecord.addField(fieldStr(SalesInvoiceTmp, InventColorIdFlag));
        childRecord.addField(fieldStr(SalesInvoiceTmp, InventSizeIdFlag));
        childRecord.addField(fieldStr(SalesInvoiceTmp, InventStyleIdFlag));
        childRecord.addField(fieldStr(SalesInvoiceTmp, PrintEuroTotals));
        childRecord.addField(fieldStr(SalesInvoiceTmp, PrintFreeTextInvoiceVATNum));
        // childRecord.addField(fieldStr(SalesInvoiceTmp, TaxPrintTaxFreeBalance)); -> This field never gets filled.
        childRecord.addField(fieldStr(SalesInvoiceTmp, IsCreditInvoicingReportEnabled_W));

        /* Add flags from the SalesInvoiceHeaderFooterTmp table */
        // We stored these flags in the addDataFieldsForHeader method into the salesInvoiceHeaderFlagFields variable.
        childRecord.addCalculatedField(fieldStr(SalesInvoiceHeaderFooterTmp, CustInvoiceRefNum_FI),
            salesInvoiceHeaderFlagFields.CustInvoiceRefNum_FI ? true : false);
        childRecord.addCalculatedField(fieldStr(SalesInvoiceHeaderFooterTmp, ShowCompanyVATNum),
            salesInvoiceHeaderFlagFields.ShowCompanyVATNum ? true : false);
        childRecord.addCalculatedField(fieldStr(SalesInvoiceHeaderFooterTmp, ShowCurrencyBankAccount),
            salesInvoiceHeaderFlagFields.ShowCurrencyBankAccount ? true : false);
        childRecord.addCalculatedField(fieldStr(SalesInvoiceHeaderFooterTmp, ShowPayer),
            salesInvoiceHeaderFlagFields.ShowPayer ? true : false);
        childRecord.addCalculatedField(fieldStr(SalesInvoiceHeaderFooterTmp, IsPaymIdVisible),
            salesInvoiceHeaderFlagFields.IsPaymIdVisible ? true : false);
        //childRecord.addCalculatedField(fieldStr(SalesInvoiceHeaderFooterTmp, PrintFreeTextInvoiceVATNum),
        //salesInvoiceHeaderFlagFields.PrintFreeTextInvoiceVATNum ? true : false); -> already added from SalesInvoiceTmp

        /* Currencies */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('Currencies');
        childRecord.setRecordLabel('Currencies');
        childRecord.addField(fieldStr(SalesInvoiceTmp, CustInvoiceJourCurrencyCode));
        childRecord.addField(fieldStr(SalesInvoiceTmp, EuroCurrencyCode));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ExchRate));
        childRecord.addField(fieldStr(SalesInvoiceTmp, StandardCurrency));
        childRecord.addField(fieldStr(SalesInvoiceTmp, CurrencySymbol));

        /* Dates */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('Dates');
        childRecord.setRecordLabel('Dates');
        childRecord.addField(fieldStr(SalesInvoiceTmp, CustInvoiceJourDueDate));
        childRecord.addField(fieldStr(SalesInvoiceTmp, DateOfCreation));

        /* Amounts */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('Amounts');
        childRecord.setRecordLabel('Amounts');
        childRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceAmount));
        childRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceAmountEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceAmountMST));
        childRecord.addField(fieldStr(SalesInvoiceTmp, PrepaidAmount));
        childRecord.addField(fieldStr(SalesInvoiceTmp, PrepaidAmountEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, RemainAmountToBePaid));
        childRecord.addField(fieldStr(SalesInvoiceTmp, RemainAmountToBePaidEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SalesBalance));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SalesBalanceEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SalesBalanceMST));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SumTax));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SumTaxEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SumTaxMST));
        childRecord.addField(fieldStr(SalesInvoiceTmp, NetAmount));
        childRecord.addField(fieldStr(SalesInvoiceTmp, NetAmountEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, EndDisc));
        childRecord.addField(fieldStr(SalesInvoiceTmp, EndDiscEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SumMarkup));
        childRecord.addField(fieldStr(SalesInvoiceTmp, SumMarkupEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceRoundOff));
        childRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceRoundOffEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, TaxableBalance));
        childRecord.addField(fieldStr(SalesInvoiceTmp, TaxableBalanceEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, TaxFreeBalance));
        childRecord.addField(fieldStr(SalesInvoiceTmp, TaxFreeBalanceEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, CashDisc));
        childRecord.addField(fieldStr(SalesInvoiceTmp, CashDiscEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ReverseChargeJournal));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ReverseChargeAmount));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ReverseChargeAmountEuro));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ReverseChargeBalance));
        childRecord.addField(fieldStr(SalesInvoiceTmp, ReverseChargeBalanceEuro));
        
        /* Mandate fields */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('MandateFields');
        childRecord.setRecordLabel('Mandate fields');
        childRecord.addField(fieldStr(SalesInvoiceTmp, MandateBankIBAN));
        childRecord.addField(fieldStr(SalesInvoiceTmp, MandateReference));
        childRecord.addField(fieldStr(SalesInvoiceTmp, MandateSWIFTNo));

        /* Notes and labels */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('NotesAndLabels');
        childRecord.setRecordLabel('Notes and labels');
        childRecord.addField(fieldStr(SalesInvoiceTmp, HeaderNotes));
        childRecord.addField(fieldStr(SalesInvoiceTmp, FormLetterRemarksTxt));
        childRecord.addField(fieldStr(SalesInvoiceTmp, TaxAmountLabel));
        childRecord.addField(fieldStr(SalesInvoiceTmp, TaxAmountMSTLabel));
        childRecord.addField(fieldStr(SalesInvoiceTmp, CashDiscTxt_LanguageId));

        /* Misc */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('Misc');
        childRecord.setRecordLabel('Misc');
        childRecord.addField(fieldStr(SalesInvoiceTmp, GiroType));
        childRecord.addField(fieldStr(SalesInvoiceTmp, CashAccountingRegime_ES));
        childRecord.addField(fieldStr(SalesInvoiceTmp, PrePrintLevel));

        /* MCR fields */
        childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
        childRecord.setRecordName('MCR');
        childRecord.setRecordLabel('MCR Markup');
        childRecord.addField(fieldStr(SalesInvoiceTmp, MCRPaymAmount));
        childRecord.addField(fieldStr(SalesInvoiceTmp, MCRDueAmount));

        /* Adjustment_TH */
        if (isoCountryCode == #isoTH)
        {
            // NOTE: Available from the July 2017 version.
            childRecord = _headerExtDataRecord.addChildRecord(salesInvoiceLineWithHeaderFields).setSingleRecord(true);
            childRecord.setRecordName('AdjustmentDetails');
            childRecord.setRecordLabel('Adjustment invoice details');
            childRecord.addField(fieldStr(SalesInvoiceTmp, AdjustmentDetailsTxt_TH));
            childRecord.addField(fieldStr(SalesInvoiceTmp, RemarkTxt_TH));
        }

        /* Redundant fields */
        //childRecord.addField(fieldStr(SalesInvoiceTmp, JournalRecId));
        /* Fields that never get filled */
        //childRecord.addField(fieldStr(SalesInvoiceTmp, CompanyRegNum));
        //childRecord.addField(fieldStr(SalesInvoiceTmp, CompanyBankRegNum));
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addBackorderLines</Name>
				<Source><![CDATA[
    protected boolean sil_addBackorderLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        /* Backorder lines */
        if (_forceAddingFields || _currentLine.ShowBackorders)
        {
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceLines_Backorder'.
            _addingRecord.setRecordName(#BackorderLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Backorder lines'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

            // Add all fields related to the backorder lines.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, BackOrderLineName));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, BackOrderLineItemId));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, BackOrderLineQuantity));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, BackOrderLineSalesUnit));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, BackOrderConfirmedDeliveryDate));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowBackOrderConfirmedDeliveryDate));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowBackorders));

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addCustTransLines</Name>
				<Source><![CDATA[
    protected boolean sil_addCustTransLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        /* Lines with prepaid amounts */
        if (_forceAddingFields || _currentLine.ShowCustTrans)
        {
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceLines_Prepayed'.
            _addingRecord.setRecordName(#PrepayedLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Prepayed lines'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

            // Add all fields related to the prepaid lines.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, CurrencyCode));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, SettledAmountCur));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, Txt));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TransDate));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowCustTrans));

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addMainLines</Name>
				<Source><![CDATA[
    protected boolean sil_addMainLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        DocXmlRecord    packingSlipDataRecord, inventDimDataRecord, mcrCallCenterDataRecord;


        boolean isCustInvoiceTransLine(SalesInvoiceTmp _salesInvoiceTmp)
        {
            boolean isCustInvoiceTransLine;
            isCustInvoiceTransLine = _salesInvoiceTmp.Qty != 0 ||
                                     // _salesInvoiceTmp.ItemId != '' ||  // SalesInvoiceDP.itemId() can return non-empty string also when ItemId is not set.
                                     _salesInvoiceTmp.Name != '' ||
                                     _salesInvoiceTmp.SalesPrice != 0 ||
                                     _salesInvoiceTmp.LineAmount != 0 ||
                                     _salesInvoiceTmp.LineAmountInclTax != 0 ||
                                     _salesInvoiceTmp.DiscPercent != 0 ||
                                     _salesInvoiceTmp.DiscountAmount != 0;
            return isCustInvoiceTransLine;
        }


        // Check if the current SalesInvoiceTmp record is a main invoice line
        // with name, qty, price, amount, etc. and add all corresponidng fields.
        if (_forceAddingFields || isCustInvoiceTransLine(_currentLine))
        {
            // (1) Change the name of the adding record from 'SalesInvoiceTmp'
            // to a more readable name, e.g. 'SalesInvoiceLines'.
            _addingRecord.setRecordName(#SalesInvoiceLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Invoice lines'); // NOTE: use literalStr("@LabelID") instead.

            // (2) Include all fields you need on the main invoice line.
            // NOTE: Exclude all fields you don't need on the report for the sake of maintenance.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ItemId));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ExternalItemId));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, DualUseCertificate));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, Name));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, Qty));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, SalesPrice));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, SalesUnitTxt));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, LineAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, LineAmountInclTax));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, DiscPercent));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, DiscountAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowGoodsDiscount));

            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxWriteCode));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, CorrectiveReasonLines));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, Notes));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, LineHeader));

            _addingRecord.addField(fieldStr(SalesInvoiceTmp, PdsEnabled));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, pdsCWUnitId));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, pdsCWQty));
            
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ReverseChargeLine));


            /* Packing slip fields */
            packingSlipDataRecord = _addingRecord.addChildRecord(_currentLine).setSingleRecord(true);
            packingSlipDataRecord.setRecordName('PackingSlip');
            packingSlipDataRecord.setRecordLabel('Packing slip'); // NOTE: use literalStr("@LabelID") instead.
            packingSlipDataRecord.addField(fieldStr(SalesInvoiceTmp, PackingSlip));
            packingSlipDataRecord.addField(fieldStr(SalesInvoiceTmp, ShowCustPackingSlipTrans));
            //-- Redudant fields (never get filled):
            //packingSlipDataRecord.addField(fieldStr(SalesInvoiceTmp, PackingSlipDeliveryDate));
            //packingSlipDataRecord.addField(fieldStr(SalesInvoiceTmp, PackingSlipTransQty));
            //packingSlipDataRecord.addField(fieldStr(SalesInvoiceTmp, PackingSlipId));


            /* InventDim fields */
            inventDimDataRecord = _addingRecord.addChildRecord(_currentLine).setSingleRecord(true);
            inventDimDataRecord.setRecordName('InventDim');
            inventDimDataRecord.setRecordLabel('Inventory dimensions'); // NOTE: use literalStr("@LabelID") instead.
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, ConfigId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventSizeId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventColorId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventSiteId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventLocationId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventBatchId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventSerialId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventStyleId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventStatusId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, WMSLocationId));
            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, LicensePlateId));

            inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventDimPrint));

            // NOTE: With the July 2017 version this field became obsolete.
            //inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, WMSPalletId));

            /* The InventDimPrint field unpacked into the InventoryDimensions records */
            // Uncomment the following code to add InventoryDimensions data records containing the corresponding inventory dimension fields.
            //DocInventDimHelper::addInventoryDimensionsRecords_SalesInvoice(_addingRecord, this.custInvoiceTrans(_currentLine.JourTransRecId_DR));


            /* MCR Markup fields */
            mcrCallCenterDataRecord = _addingRecord.addChildRecord(_currentLine).setSingleRecord(true);
            mcrCallCenterDataRecord.setRecordName('MCRMarkup');
            mcrCallCenterDataRecord.setRecordLabel('MCR Markup'); // NOTE: use literalStr("@LabelID") instead.
            mcrCallCenterDataRecord.addField(fieldStr(SalesInvoiceTmp, MCRMarkupTxt));
            mcrCallCenterDataRecord.addField(fieldStr(SalesInvoiceTmp, MCRMarkupValue));
            mcrCallCenterDataRecord.addField(fieldStr(SalesInvoiceTmp, MCRMarkupCalculatedAmount));


            // TODO: Add Financial dimensions fields 
            //_addingRecord.addCalculatedFieldFromEdt(#DefaultDimensionField, extendedTypeStr(DimensionDefault), this.custInvoiceTrans(_currentLine.JourTransRecId_DR).DefaultDimension);


            /* Redudant fields (never get filled) */
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, showPreviouslyInvoiced));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, MCRMarkupCode));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, MCRHeadingLine));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, MCRTableNum));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, MCRInventTrans_ItemId));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, MCRInventTransQty));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, MCRPayment));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, PaymentId));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, PaymentStubInvoiceId));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, PaymentStubDueDate));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, CustInvoiceBackorderLineName));
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, IsTaxAmountVisible));


            /* COUNTRY REGION SPECIFIC DATA FIELDS */
            switch (isoCountryCode)
            {
                case #isoRU:
                    inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventGTDId_RU));
                    inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventGTDIdFlag_RU));
                    inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventOwnerId_RU));
                    inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventOwnerIdFlag_RU));
                    inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventProfileId_RU));
                    inventDimDataRecord.addField(fieldStr(SalesInvoiceTmp, InventProfileIdFlag_RU));
                    break;

                case #isoMY:
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, GSTReliefItemNumber_MY));
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, GSTReliefSchedule_MY));
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, RefInvoiceDate_MY));
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, RefInvoiceID_MY));
                    break;

                case #isoIN:
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, CommodityCode_IN));
                    break;

                case #isoIT:
                    /* Feature: (Italy) Sales invoice lines sorting per packing slips */
                    // We will add these fields on the flat to enable easier grouping and sorting.
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, PackingSlipId));
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, PackingSlipDeliveryDate));
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, SortPerPackingSlip_IT));
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceReportLineType_IT));

                    /* Feature: (Italy) Tax invoice for goods delivered for free */
                    _addingRecord.addField(fieldStr(SalesInvoiceTmp, GoodsForFree_IT));
                    // _addingRecord.addField(fieldStr(SalesInvoiceTmp, InvoiceForFree_IT)); // Redudant field (never get filled)
                    break;
            }
            
            // Add Extension fields defined on SalesInvoiceTmp, if any.
            // NOTE: Fields will be added to the child record named ExtensionFields. Change the last parameter to false to add
            // Extension fields on flat. If the result doesn't suit you, add your Extension fields directly using the addField() method.
            DocExtensionFieldsHelper::tryAddAllExtensionFieldsToDataRecord(_currentLine, _addingRecord, true, extensionFieldsMetadata_SalesInvoiceTmp);


            // TODO: Add here additional fields from the related CustInvoiceTrans table (or some other tables).
            //CustInvoiceTrans custInvoiceTrans = this.custInvoiceTrans(_currentLine.JourTransRecId_DR);
            //_addingRecord.addCalculatedField('OrigSalesId', custInvoiceTrans.OrigSalesId);
            //_addingRecord.addCalculatedField('LineAmountTax', custInvoiceTrans.LineAmountTax);
            //_addingRecord.addCalculatedField('LineNum', custInvoiceTrans.LineNum);

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addMarkupLines</Name>
				<Source><![CDATA[
    protected boolean sil_addMarkupLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        /* Markup lines */
        if (_forceAddingFields || _currentLine.ShowMarkupTrans)
        {
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceLines_Markup'.
            _addingRecord.setRecordName(#MarkupLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Markup lines'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

            // Add all fields related to the markup lines.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, MarkupCode));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, MarkupTaxCode));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, MarkupAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowMarkupTrans));

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addPackMaterialLines</Name>
				<Source><![CDATA[
    protected boolean sil_addPackMaterialLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        /* PackingMaterial lines */
        if (_forceAddingFields || _currentLine.ShowPackingMaterial)
        {
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceLines_PackingMaterial'.
            _addingRecord.setRecordName(#PackingMaterialLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Packing materials lines'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

            // Add all fields related to the PackingMaterial lines.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, PackMaterialName));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, PackagingWeight));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, PackMaterialUnit));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, PackMaterialCode));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, PackagingMaterialText));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowPackingMaterial));

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addPaymSchedLines</Name>
				<Source><![CDATA[
    protected boolean sil_addPaymSchedLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        /* PaymentSchedule lines */
        if (_forceAddingFields || _currentLine.ShowCustPaymSched)
        {
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceLines_PaymSched'.
            _addingRecord.setRecordName(#PaymSchedLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Payment scheduled lines'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

            // Add all fields related to the PaymentScheduled lines.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, DueDate));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, DueAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, DiscAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, DiscDate));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowCustPaymSchedLine));

            // Store the value of the ShowCustTrans flag which has the same meaning the showCustPaymSched flag.
            showCustPaymSched = _currentLine.ShowCustPaymSched;

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addTaxTransLines</Name>
				<Source><![CDATA[
    protected boolean sil_addTaxTransLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        /* Lines with taxes */
        if (_forceAddingFields || _currentLine.ShowTaxTrans)
        {
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceLines_Tax'.
            _addingRecord.setRecordName(#TaxLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Taxes'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

            // Add all fields related to the tax lines.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, Amount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxAmountMST));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxBaseAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxBaseAmountMST));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, CashDiscAmount));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxExemptDescription));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxBaseQty));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, PrintCode));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxCode));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowTaxTrans));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, GSTSummaryText_MY));

            //-- Redudant fields (never get filled):
            //_addingRecord.addField(fieldStr(SalesInvoiceTmp, IsTaxAmountMST));

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>sil_addTaxWithholdLines</Name>
				<Source><![CDATA[
    protected boolean sil_addTaxWithholdLines(DocXmlRecord _addingRecord, SalesInvoiceTmp _currentLine, boolean _forceAddingFields)
    {
        /* Lines with taxes with hold transactions */
        if (_forceAddingFields || _currentLine.ShowTaxWithholdTrans_IN)
        {
            // Rename the record from 'SalesInvoiceTmp' to 'SalesInvoiceLines_TaxWithhold'.
            _addingRecord.setRecordName(#TaxWithholdLines);
            // Change the label of the record.
            _addingRecord.setRecordLabel('Withhold taxes'); // NOTE: use setRecordLabelId(literalStr("@LabelID")) instead.

            // Add all fields related to the tax withhold lines.
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, SumTaxWithhold_IN));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, TaxWithholdCode_IN));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, SourceBaseAmountCur_IN));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, SourceRegulateAmountCur_IN));
            _addingRecord.addField(fieldStr(SalesInvoiceTmp, ShowTaxWithholdTrans_IN));

            return true;
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>skipRdpTableRecord</Name>
				<Source><![CDATA[
    protected boolean skipRdpTableRecord(Common _rdpTableRecord, TableName _rdpTableName)
    {
        // Skip each record from the SalesInvoiceLocalizationTmp table if isoCountryCode
        // is not one of the listed countries below.
        // This means that for other than these countries, the SalesInvoiceLocalizationTmp table
        // will not be presented in the report data source.
        if (tableStr(SalesInvoiceLocalizationTmp) == _rdpTableName)
        {
            switch (isoCountryCode)
            {
                case #isoEE, #isoLT, #isoHU, #isoLV, #isoCZ, #isoPL:
                    return false;

                default:
                    return true;
            }
        }

        return false;
    }

]]></Source>
			</Method>
			<Method>
				<Name>onSelectedRdpTableRecord</Name>
				<Source><![CDATA[
    protected void onSelectedRdpTableRecord(Common _rdpTableRecord, TableName _rdpTableName)
    {
        super(_rdpTableRecord, _rdpTableName);

        if (_rdpTableName == tableStr(SalesInvoiceHeaderFooterTmp))
        {
            SalesInvoiceHeaderFooterTmp header = _rdpTableRecord;

            // Store custom placeholders' values.
            placeholder_salesId = header.SalesId;
            placeholder_invoiceAccount = header.InvoiceAccount;
            placeholder_invoicingName = header.InvoicingName;
            placeholder_custRef = header.CustomerRef;
            placeholder_custReq = header.PurchaseOrder;
            placeholder_contactName = header.ContactPersonName;
            placeholder_invoiceDate = header.InvoiceDate;
            placeholder_paymentCondition = header.PaymentCondition;

            salesTable = SalesTable::find(header.SalesId);
        }
        else if (_rdpTableName == tableStr(SalesInvoiceTmp))
        {
            // Store custom placeholders' values.
            if (!placeholder_invoiceId)
            {
                SalesInvoiceTmp line = _rdpTableRecord;
                placeholder_invoiceId = line.InvoiceId;
                placeholder_dueDate = line.CustInvoiceJourDueDate;
            }
        }
    }

]]></Source>
			</Method>
			<Method>
				<Name>overrideReportRunSettings</Name>
				<Source><![CDATA[
    // List of defined custom placeholders for the report:
    #define.InvoiceId('InvoiceId')
    #define.SalesId('SalesId')
    #define.InvoiceAccount('InvoiceAccount')
    #define.InvoicingName('InvoicingName')
    #define.CustContactName('CustContactName')
    #define.CustRef('CustRef')
    #define.CustReq('CustReq')
    #define.InvoiceDate('InvoiceDate')
    #define.DueDate('DueDate')
    #define.PaymentCondition('PaymentCondition')
    #define.OrderAccountPrimaryEmail('OrderAccountPrimaryEmail')
    #define.OrderAccountInvoicePurposeEmail('OrderAccountInvoicePurposeEmail')
    #define.OrderEmail('OrderEmail')

    [DocPlaceholderAttribute(#InvoiceId, 'INV - Invoice ID'),
     DocPlaceholderAttribute(#SalesId, 'INV - Sales ID'),
     DocPlaceholderAttribute(#InvoiceAccount, 'INV - Customer Account ID'),
     DocPlaceholderAttribute(#InvoicingName, 'INV - Customer Name'),
     DocPlaceholderAttribute(#CustContactName, 'INV - Contact Name'),
     DocPlaceholderAttribute(#CustRef, 'INV - Customer Reference'),
     DocPlaceholderAttribute(#CustReq, 'INV - Customer Requisition'),
     DocPlaceholderAttribute(#InvoiceDate, 'INV - Invoice Date'),
     DocPlaceholderAttribute(#DueDate, 'INV - Due Date'),
     DocPlaceholderAttribute(#PaymentCondition, 'INV - Payment Condition'),
     DocPlaceholderAttribute(#OrderAccountPrimaryEmail, 'INV - Order Account Primary Email'),
     DocPlaceholderAttribute(#OrderAccountInvoicePurposeEmail, 'INV - Order Account Invoice Purpose Email'),
     DocPlaceholderAttribute(#OrderEmail, 'INV - Sales Order Email')]
    public DocPlaceholderManager overrideReportRunSettings(DocReportRunContext _reportRunContext, boolean _replaceStandardPlaceholders = true)
    {
        // Set the report execution context record to the corresponding salesTable. This will affect:
        // (1) Standard placeholders
        // (2) Saving to Attachments -> Record type: Context record
        // (3) Additional Attachments -> Load from: Context record
        _reportRunContext.setReportExecutionContextRecord(salesTable);

        // Replace standard placeholders.
        DocPlaceholderManager placeholderMng = super(_reportRunContext, _replaceStandardPlaceholders);
        
        // Replace custom placeholders:
        // -- Placeholder @InvoiceId@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#InvoiceId, placeholder_invoiceId);

        // -- Placeholder @SalesId@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#SalesId, placeholder_salesId);
        
        // -- Placeholder @InvoiceAccount@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#InvoiceAccount, placeholder_invoiceAccount);

        // -- Placeholder @InvoicingName@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#InvoicingName, placeholder_invoicingName);

        // -- Placeholder @InvoiceDate@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#InvoiceDate, placeholder_invoiceDate);

        // -- Placeholder @DueDate@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#DueDate, placeholder_dueDate);

        // -- Placeholder @OrderEmail@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#OrderEmail, salesTable.Email);

        // -- Placeholder @CustContactName@
        if (!placeholder_contactName)
        {
            placeholder_contactName = DocDspHelper::SirMadam;
        }
        placeholderMng.replacePlaceholderInCurrentPrintDest(#CustContactName, placeholder_contactName);

        // -- Placeholder @CustRef@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#CustRef, placeholder_custRef);

        // -- Placeholder @CustReq@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#CustReq, placeholder_custReq);

        // -- Placeholder @PaymentCondition@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#PaymentCondition, placeholder_paymentCondition);

        // -- Placeholder @OrderAccountPrimaryEmail@
        this.setPlaceholders_OrderAccountContactEmails();
        placeholderMng.replacePlaceholderInCurrentPrintDest(#OrderAccountPrimaryEmail, placeholder_orderAccountPrimaryEmail);

        // -- Placeholder @OrderAccountInvoicePurposeEmail@
        placeholderMng.replacePlaceholderInCurrentPrintDest(#OrderAccountInvoicePurposeEmail, placeholder_orderAccountInvoicePurposeEmail);

        // Fill the Print archive contract.
        _reportRunContext.archiveContract().setCustAccount(placeholder_invoiceAccount);
        _reportRunContext.archiveContract().setSalesId(placeholder_salesId);
        _reportRunContext.archiveContract().setDocument(placeholder_invoiceId, placeholder_invoiceDate);
        _reportRunContext.archiveContract().setJournal(this.custInvoiceJour().RecId, DocJournalType::CustInvoiceJour);

        return placeholderMng;
    }

]]></Source>
			</Method>
			<Method>
				<Name>setPlaceholders_OrderAccountContactEmails</Name>
				<Source><![CDATA[
    protected void setPlaceholders_OrderAccountContactEmails()
    {
        CustAccount orderAccount = this.custInvoiceJour().OrderAccount;
        CustTable orderCustomer = CustTable::find(orderAccount);

        placeholder_orderAccountPrimaryEmail = orderCustomer.email();

        // Note that the following logic will work only for Purpose with ID = 'Invoice'.
        container custContactInfoPurposeEmailsCon =
                DirParty::electronicAddressLocatorsByRole(orderCustomer.Party, LogisticsElectronicAddressMethodType::Email, 'Invoice');

        str custContactInfoPurposeEmailsStr = '';
        if (custContactInfoPurposeEmailsCon != conNull())
        {
            custContactInfoPurposeEmailsStr = conPeek(custContactInfoPurposeEmailsCon, 1);
            for (int i = 2; i <= conLen(custContactInfoPurposeEmailsCon); i++)
            {
                custContactInfoPurposeEmailsStr = custContactInfoPurposeEmailsStr + ',' + conPeek(custContactInfoPurposeEmailsCon, i);
            }
        }

        placeholder_orderAccountInvoicePurposeEmail = custContactInfoPurposeEmailsStr;
    }

]]></Source>
			</Method>
			<Method>
				<Name>populateGiroReportTmpTable</Name>
				<Source><![CDATA[
    /// <summary>
    /// Logic of this method is taken from table method GiroReportTmp::populate().
    /// The only difference is that this method does not insert data into GiroReportTmp table.
    /// </summary>
    /// <param name = "_data">SalesInvoicePaymentStubTmp record buffer</param>
    /// <returns>GiroReportTmp record buffer</returns>
    /// <remarks>
    /// Call this method from the this.addDataFieldsForRdpTableRecord() method, if you need both Invoice and Giro data
    /// to be part of the same DDSP and available for use on all the Sales Invoice report templates.
    /// </remarks>
    protected GiroReportTmp populateGiroReportTmpTable(GiroReport _data)
    {
        GiroReportTmp tmp;

        tmp.CompanyGiro = _data.CompanyGiro;
        tmp.AmountCheckId = _data.AmountCheckId;
        tmp.InvoiceAmountNODecimals = _data.InvoiceAmountNODecimals;
        tmp.InvoiceAmountDecimals = _data.InvoiceAmountDecimals;
        tmp.OcrField = _data.OcrField;
        tmp.CompanyAddress = _data.CompanyAddress;
        tmp.CompanyName = _data.CompanyName;
        tmp.CustAddress_CH = _data.CustAddress_CH;
        tmp.CustName_CH = _data.CustName_CH;
        tmp.AccountNum = _data.AccountNum;
        tmp.InvoiceAmount = _data.InvoiceAmount;
        tmp.InvoiceAccount = _data.InvoiceAccount;
        tmp.InvoiceName = _data.InvoiceName;
        tmp.InvoiceAddress = _data.InvoiceAddress;
        tmp.fiCreditorID_DK = _data.fiCreditorID_DK;
        tmp.CompanyPhone = _data.CompanyPhone;
        tmp.DueDate = _data.DueDate;
        tmp.BankGroupIdName_CH = _data.BankGroupIdName_CH;
        tmp.BankZipCode_CH = _data.BankZipCode_CH;
        tmp.BankAccountTable_AccountNum_CH = _data.BankAccountTable_AccountNum_CH;
        tmp.BankAccountTable_Clearing_CH = _data.BankAccountTable_Clearing_CH;
        tmp.AccountNo1_CH = _data.AccountNo1_CH;
        tmp.PaymentId2_PaymentId3_CH = _data.PaymentId2_PaymentId3_CH;
        tmp.Description_CH = _data.Description_CH;
        tmp.PaymentRef1_CH = _data.PaymentRef1_CH;
        tmp.PaymentRef2_CH = _data.PaymentRef2_CH;
        tmp.LayoutCode_CH = _data.LayoutCode_CH;
        tmp.AccountNo2_CH = _data.AccountNo2_CH;
        tmp.OcrLine_CH = _data.OcrLine_CH;
        tmp.CurrencyCodeISO_CH = _data.CurrencyCodeISO_CH;
        tmp.RemainAmountToBePaid = _data.RemainAmountToBePaid;

        if (_data.GiroType == PaymentStub::Finnish)
        {
            tmp.AccountNum1_FI = _data.AccountNum1_FI;
            tmp.AccountNum2_FI = _data.AccountNum2_FI;
            tmp.AccountNum4_FI = _data.AccountNum4_FI;
            tmp.AccountNum6_FI = _data.AccountNum6_FI;
            tmp.AccountNum3_FI = _data.AccountNum3_FI;
            tmp.AccountNum5_FI = _data.AccountNum5_FI;
            tmp.OcrLine_FI = _data.OcrLine_FI;
            if (SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, InvoiceReferenceNumberFI)))
            {
                tmp.InvoiceReferenceNumberFI = _data.InvoiceReferenceNumberFI;
            }
        }

        tmp.GiroType = _data.GiroType;

        if (SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, InvoiceId)))
        {
            tmp.InvoiceId = _data.InvoiceId;
        }

        if (SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, IsInvoiceAmount)))
        {
            tmp.IsInvoiceAmount = _data.IsInvoiceAmount;
        }

        if (_data.GiroType == PaymentStub::QRBill)
        {
            tmp.InvoiceAmountTotal = SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, InvoiceAmountTotal))
                ? _data.InvoiceAmountTotal
                : _data.InvoiceAmount;
            tmp.IBAN = SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, IBAN))
                ? _data.IBAN
                : '';
            
            LogisticsPostalAddress address = CompanyInfo::find().postalAddress();
            tmp.CompanyAddressLine1 = strRemoveCr(address.Street);
            tmp.CompanyAddressLine2 = strFmt('%1 %2', address.ZipCode, address.City);

            tmp.InvoiceAddressLine1 = SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, InvoiceAddressLine1))
                ? _data.InvoiceAddressLine1
                : '';
            tmp.InvoiceAddressLine2 = SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, InvoiceAddressLine2))
                ? _data.InvoiceAddressLine2
                : '';
            tmp.InvoiceCountryRegionId = SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, InvoiceCountryRegionId))
                ? _data.InvoiceCountryRegionId
                : '';
            tmp.BillInformation = SysDictField::isFieldMapped(tableStr(GiroReport), tableId2Name(_data.TableId), fieldStr(GiroReport, BillInformation))
                ? _data.BillInformation
                : '';

            CustQRBillQRCodeCreator_CH qrCodeCreator = CustQRBillQRCodeCreator_CH::newFromGiroTable(tmp);
            try
            {
                tmp.QRCode = qrCodeCreator.generateQRCode();
            }
            catch
            {
                DocGlobalHelper::handleException(funcName(), 'Failed to generate QR code');
            }

            tmp.PrintScissorsSymbol = CustGiroReportProcessingGroup_CH::findByCustAccount(tmp.InvoiceAccount).PrintScissorsSymbol == NoYes::Yes;
        }

        return tmp;
    }

]]></Source>
			</Method>
			<Method>
				<Name>main</Name>
				<Source><![CDATA[
    /// <summary>
    /// -- When to use this method?
    /// If you want to quickly generate DDSP for a sample journal record.
    /// -- How to run it?
    /// Set up this class as the startup object in your project.
    /// -- NOTE
    /// Please verify all TODOs in the method and make changes if needed.
    /// </summary>
    /// <param name = "_args">An instance of the Args class</param>
    public static void main(Args _args)
    {
        CustInvoiceJour custInvoiceJour;

        // TODO: (1) Select the sample journal record.
        select firstonly custInvoiceJour where custInvoiceJour.SalesId != '';

        // Add it as the context record, which is going to be printed.
        Args args = new Args();
        args.record(custInvoiceJour);

        SalesInvoiceController controller = SalesInvoiceController::construct();

        // TODO: (2) Change the name SSRS Report Design if needed.
        controller.parmReportName(PrintMgmtDocType::construct(PrintMgmtDocumentType::SalesOrderInvoice).getDefaultReportFormat());
        controller.parmArgs(args);
        
        SalesInvoiceContract rdpContract = controller.parmReportContract().parmRdpContract();
        rdpContract.parmRecordId(custInvoiceJour.RecId);
        rdpContract.parmCountryRegionISOCode(SysCountryRegionCode::countryInfo());

        // Set the Docentric Generate DS print destination settings.
        SRSPrintDestinationSettings pds = controller.parmReportContract().parmPrintSettings();
        pds.printMediumType(SRSPrintMediumType::GenerateDataSource_DC);

        // TODO: (3) Set Design and Preview languages if needed.
        pds.parmGenerateDSPrintDestSettings_DC().parmLanguageId(custInvoiceJour.LanguageId);
        pds.parmGenerateDSPrintDestSettings_DC().parmPreviewLanguages('fr,de,it,es');

        // Initalize SalesInvoiceJournalPrint class instance because there is no other way
        // NOT to use Print Management.
        SalesInvoiceJournalPrint salesInvoiceJournalPrint = SalesInvoiceJournalPrint::construct();
        salesInvoiceJournalPrint.parmPrintFormletter(NoYes::Yes);
        salesInvoiceJournalPrint.parmUsePrintManagement(false);
        salesInvoiceJournalPrint.parmUseUserDefinedDestinations(true);
        salesInvoiceJournalPrint.parmPrinterSettingsFormLetter(controller.parmReportContract().parmPrintSettings().pack());
        
        args.caller(salesInvoiceJournalPrint);
        args.parmEnumType(enumNum(PrintCopyOriginal));
        args.parmEnum(PrintCopyOriginal::OriginalPrint);

        controller.parmExecutionMode(SysOperationExecutionMode::Synchronous);
        controller.parmShowDialog(false);
        controller.startOperation();
    }

]]></Source>
			</Method>
		</Methods>
	</SourceCode>
</AxClass>